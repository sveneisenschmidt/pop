<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Pop Analytics</title>
    </head>
    <body>
        <h1>Pop Analytics</h1>
        <div id="content">Loading...</div>

        <script>
            const content = document.getElementById("content");

            async function loadStats() {
                try {
                    const response = await fetch("/api/stats");
                    if (!response.ok)
                        throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    renderStats(data);
                } catch (error) {
                    content.innerHTML = `Error: ${error.message}`;
                }
            }

            function renderStats(data) {
                const { global, pages } = data;

                let html = `
                <h2>Overview</h2>
                <table border="1" cellpadding="8" cellspacing="0">
                    <tr>
                        <td><strong>Unique Visitors</strong><br><small>Distinct people</small></td>
                        <td align="right"><strong>${global.uniqueVisitors}</strong></td>
                    </tr>
                    <tr>
                        <td><strong>Page Views</strong><br><small>Total page loads</small></td>
                        <td align="right"><strong>${global.totalVisits}</strong></td>
                    </tr>
                    <tr>
                        <td><strong>Reactions</strong><br><small>Emoji clicks</small></td>
                        <td align="right"><strong>${global.totalReactions}</strong></td>
                    </tr>
                    <tr>
                        <td><strong>Pages</strong><br><small>Tracked pages</small></td>
                        <td align="right"><strong>${global.totalPages}</strong></td>
                    </tr>
                </table>

                <h2>Per Page</h2>
                <table border="1" cellpadding="8" cellspacing="0">
                    <thead>
                        <tr>
                            <th align="left">Page</th>
                            <th align="right">Unique Visitors</th>
                            <th align="right">Page Views</th>
                            <th align="right">Reactions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

                for (const page of pages) {
                    html += `
                    <tr>
                        <td>${escapeHtml(page.pageId)}</td>
                        <td align="right">${page.uniqueVisitors}</td>
                        <td align="right">${page.totalVisits}</td>
                        <td align="right">${page.totalReactions}</td>
                    </tr>
                `;
                }

                if (pages.length === 0) {
                    html += `<tr><td colspan="4">No data yet</td></tr>`;
                }

                html += `</tbody></table>`;
                content.innerHTML = html;
            }

            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            loadStats();
        </script>
    </body>
</html>
