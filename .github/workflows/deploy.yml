name: Deploy

on:
    workflow_dispatch:

jobs:
    test:
        if: github.actor == 'sveneisenschmidt'
        uses: ./.github/workflows/test.yml

    deploy:
        needs: test
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.4"
                  extensions: ctype, iconv
                  coverage: none

            - name: Install dependencies
              run: |
                  composer install --no-dev --no-scripts --optimize-autoloader --no-progress
                  npm ci

            - name: Build assets
              run: npm run build

            - name: Setup SSH
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
                  chmod 600 ~/.ssh/deploy_key
                  ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

            - name: Ensure directories exist on server
              run: |
                  ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
                    "mkdir -p ${{ secrets.DEPLOY_PATH }}/var ${{ secrets.DEPLOY_PATH }}/backup"

            - name: Backup database
              run: |
                  ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
                    "if [ -f ${{ secrets.DEPLOY_PATH }}/var/data.db ]; then cp ${{ secrets.DEPLOY_PATH }}/var/data.db ${{ secrets.DEPLOY_PATH }}/backup/\$(date +%Y%m%d_%H%M%S)_data.db; fi"

            - name: Deploy via rsync
              run: |
                  rsync -avz --delete \
                    --include='bin/***' \
                    --include='config/***' \
                    --include='public/***' \
                    --include='src/***' \
                    --include='vendor/***' \
                    --exclude='*' \
                    -e "ssh -i ~/.ssh/deploy_key" \
                    ./ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}
